<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <link rel="shortcut icon" href="ico.png">
    <script src="jquery-3-6-0-min.js"></script>
    <meta charset="UTF-8">
    <style>
        .Sender{
            color:blue;
        }
        .SystemText{
            color: grey;
            text-align: center;
        }
        .Message{
            margin-left: 20px;
        }
        html,body{
            width: 99%;
            height: 99%;
            background-color:#87CEEB;
        }
        .ChatShow{
            overflow-y: auto;
            overflow-x:hidden;
            width:80%;
            height:75%;
            border:2px solid #87CEEB;
            background-color:#ffffff;

        }
        .MessageSend{
            width:80%;
            height:15%;
        }
        .MemberList{
            float:right;
            border:2px solid #87CEEB;
            background-color:#ffffff;
            height:93%;
            width:19%;
        }
        .Members{
            color: blue;
        }
    </style>
</head>

<body>
<div>
    <div style="float: left; margin-right: 20%">
        <tback id="Welcome">Welcome <a id="Nickname"></a>, Please select the channel</tback>
        <select id="Channel" onchange="ChannelChange(this)">
        </select>
    </div>



    <div style="text-align:right" >
        <a href="javascript:;" onclick = "Logout()">Log Out</a>
    </div>

</div>
<div class = "MemberList">
    <div>Members in Channel:</div>
</div>
<div class="ChatShow">

</div>

<button>1</button>
<button>1</button>
<button>1</button>
<button onclick="SendMessage()">Send</button>
<div class = "MessageSend">
    <textarea id="SendText" onkeypress="SendKeyPress(event)" style="width:100%;height:100%;" value="" disabled="true"></textarea>
</div>


</body>

</html>

<script type="text/javascript">
    GetBasicInfo()
    console.log(document.domain)
    let WSClient1;

    function GotoNewChannel(ChannelID){
        console.log("GOTO:"+ChannelID)
        WSClient1 = new WSClient(ChannelID)
    }
    function ChannelChange(SelectBox){
        WSClient1.Close()
        GotoNewChannel(SelectBox.value)

    }
    function CleanToken(){
        let PastDate=new Date();
        PastDate.setTime(-86400);
        document.cookie="token=''; expires="+PastDate.toGMTString();
        window.location.href="login.html"
    }
    function Logout(){
        $.ajax({
            url: "logout.ajax",
            type: "get",
            dataType: "json",
            success: function (Response,Status){
                CleanToken()
            }
        });
    }
    function GetBasicInfo(){
        $.ajax({
            url: "getbasicinfo.ajax",
            type: "get",
            dataType: "json",
            success: function (Response,Status){
                if(Response.Success===false){
                    CleanToken()
                }else{
                    $("#Nickname")[0].innerText = Response.Nickname

                }
                let ChannelSelect = $("#Channel")
                Response.Channels.forEach(function (Channel){
                    ChannelSelect.append("<option value =\""+Channel._id+"\">"+Channel.Name+"</option>")


                })
                GotoNewChannel(Response.Channels[0]._id)

            }
        });
    }
    function SendMessage(){
        let SendText = $("#SendText")[0]
        if(SendText.value!==""){
            WSClient1.SendMessage(SendText.value);
            SendText.value = "";
        }
    }
    function SendKeyPress(event){
        if(event.shiftKey === false && event.charCode === 13){
            event.preventDefault();//Invalidate newline operation
            SendMessage();
        }

    }
    class WSClient{
        constructor(ChannelID){
            this.ChatShow = $('.ChatShow')
            this.socket = new WebSocket("ws://"+document.domain+":8989/ChannelID="+ChannelID);
            let ThisClass = this;
            this.socket.onopen = function (event){ ThisClass.Initialize(event)}
            this.socket.onmessage = function (event){ ThisClass.RecvMessage(event)}
            this.socket.onclose =  function (event){ThisClass.ServerClose(event)}
        }
        Initialize(){
            console.log(this.socket)
            this.socket.send(JSON.stringify({Action:"join"}));
            $("#SendText").attr("disabled",false)
        }
        ShowMessage(Message){
            Message.MessageText = Message.MessageText.replace(/\n/g,"<br>")
            if(Message.MessageType==="system"){

                this.ChatShow.append("<div class='SystemText'>"+Message.MessageText+"</div>");
            }else if(Message.MessageType==="normal"){
                let now = new Date()
                this.ChatShow.append("<div class='Sender'>"+Message.Sender+" Says at "+now.toLocaleTimeString()+":</div>");
                this.ChatShow.append("<div class='Message'>"+Message.MessageText+"</div>");
            }


            this.ChatShow.scrollTop(this.ChatShow[0].scrollHeight);
        }
        RecvMessage(event){
            let RecvJson=JSON.parse(event.data)
            if(RecvJson.Action==="Message"){
                this.ShowMessage(RecvJson)
            }
            else if(RecvJson.Action==="UpdateUserList"){
                let MemberList = $(".MemberList")
                $(".Members").remove()
                RecvJson.UserList.forEach(function (UserNickname){
                    MemberList.append("<div class='Members'>"+UserNickname+"</div>")
                })


            }

        }
        SendMessage(Message){
            this.socket.send(JSON.stringify({Action:"Message", MessageText:Message}))
        }
        ServerClose(){
            console.log("Socket has closed");
        }
        Close(){
            this.ChatShow.empty()
            this.socket.close()
        }

    }



</script>